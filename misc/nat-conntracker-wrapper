#!/usr/bin/env bash
set -o errexit
set -o pipefail

main() {
  : "${RUNDIR:=/var/tmp/travis-run.d}"

  __loadenv

  : "${NAT_CONNTRACKER_CONNTRACK_ARGS:=-o xml -E conntrack}"
  : "${NAT_CONNTRACKER_SELF_IMAGE:-travisci/nat-conntracker:master}"

  local env_file="${RUNDIR}/nat-conntracker.env"
  printenv | grep ^NAT_CONNTRACKER | sort >"${env_file}"

  docker rm nat-conntracker || true

  conntrack ${NAT_CONNTRACKER_CONNTRACK_ARGS} |
    docker run \
      --rm \
      --user nobody \
      --interactive \
      --attach STDIN \
      --attach STDOUT \
      --attach STDERR \
      --name nat-conntracker \
      --env-file "${env_file}" \
      "${NAT_CONNTRACKER_SELF_IMAGE}"
}

__loadenv() {
  : "${ETC_DEFAULT:=/etc/default}"

  for config_file in \
    nat-conntracker \
    nat-conntracker-cloud-init \
    nat-conntracker-local; do
    if [ -f "${ETC_DEFAULT}/${config_file}" ]; then
      set -o allexport
      source "${ETC_DEFAULT}/${config_file}"
      set +o allexport
    fi
  done
}

main "$@"
